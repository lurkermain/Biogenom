# Biogenom

1. Описание решения и Архитектура

Приложение построено без использования Minimal API и Top-Level Statements, что обеспечивает строгую типизацию и четкое разделение ответственности.

Логика работы разделена на два этапа:

Первичный анализ (Object Detection): Система принимает URL, загружает изображение и просит нейросеть выделить только физические объекты. Ссылка на изображение и сырой ответ сохраняются в БД.

Глубокий анализ (Material Analysis): Пользователь (или фронтенд) подтверждает или корректирует список объектов. Система отправляет этот список обратно нейросети вместе с изображением, чтобы для каждого утвержденного предмета определить материалы. Результат сохраняется в нормализованном виде.

Интеграция с GigaChat:

Реализован механизм автоматической авторизации (обмен AuthKey на AccessToken).

Используется загрузка файлов через /api/v1/files (MultipartFormData), так как передача Base64 в JSON теле часто вызывает ошибки валидации (400 Bad Request) на больших изображениях.

Реализован механизм SemaphoreSlim для потокобезопасного обновления токена.

2. Схема Базы Данных (ER-диаграмма)
Используется нормализованная схема (3NF) PostgreSQL.

Описание сущностей:

AnalysisRequests: Хранит контекст запроса (ID, URL картинки, дату).

DetectedObjects: Хранит конкретные предметы, привязанные к запросу (например, "Стол").

ObjectMaterials: Хранит материалы, из которых сделан предмет (например, "Дерево", "Металл"). Связь "Один ко многим", так как один предмет может состоять из нескольких материалов.

3. Промпты (Prompts)
Для обеспечения строгого формата ответа (JSON) используются следующие системные инструкции.

Промпт №1: Определение предметов

"Ты - эксперт по анализу изображений. Твоя задача - перечислить основные физические предметы на фото. Верни ТОЛЬКО JSON массив строк. Например: ["стол", "стул"]. Не пиши ничего кроме JSON."

Промпт №2: Определение материалов

"На изображении присутствуют следующие предметы: {список_предметов}. Для каждого предмета определи материал, из которого он сделан (например: металл, дерево, пластик). Верни ТОЛЬКО JSON массив объектов с полями 'objectName' и 'materials' (массив строк). Пример: [{"objectName": "стол", "materials": ["металл"]}]"


4. Порядок запуска
База данных:

Убедитесь, что установлен PostgreSQL.

Заполните конфигурацию в соответсвии с вашими данными (appsettings.json):

JSON
{
  "ConnectionStrings": {
    "DefaultConnection": "Host=localhost;Port=5432;Database=ObjectDetectorDb;Username=postgres;Password=ваш_пароль"
  },
  "GigaChat": {
    "AuthKey": "ВАШ_BASE64_KEY_ИЗ_ЛИЧНОГО_КАБИНЕТА",
    "Scope": "GIGACHAT_API_PERS"
  },
  "Logging": { "LogLevel": { "Default": "Information" } },
  "AllowedHosts": "*"
}

Запуск:

Выполните dotnet restore.

Выполните dotnet run.

Приложение автоматически создаст таблицы в БД при первом старте.

Тестирование:

Отправьте POST запрос на /api/Analysis/detect-objects с JSON: {"imageUrl": "ССЫЛКА НА КАРТИНКУ"}.

Получите ID и список предметов.

Отредактируйте список предметов по необходимости и вставьте объекты по которым вы хотите узнать их материал.

Отправьте POST запрос на /api/Analysis/detect-materials с JSON: {"requestId": "ID которое вы получили с прошлого запроса", "confirmedObjects": ["стол", "стул"]}.
